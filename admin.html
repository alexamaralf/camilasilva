<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin ERP Pro | Camila Silva</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { 
      --bg: #1e1e2f; 
      --sidebar: #27293d; 
      --primary: #e14eca; 
      --primary-hover: #bf3caf;
      --text: #fff; 
      --text-muted: #a0a0a0;
      --success: #00f2c3; 
      --danger: #fd5d93; 
      --card-bg: #2e2e40; 
      --input-bg: #1d1d2b;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
    
    /* --- LAYOUT GERAL --- */
    #connectionStatus { position: fixed; top: 10px; right: 20px; z-index: 1000; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .status-ok { background: rgba(0, 242, 195, 0.2); color: var(--success); border: 1px solid var(--success); }
    .status-err { background: rgba(253, 93, 147, 0.2); color: var(--danger); border: 1px solid var(--danger); }

    .sidebar { width: 260px; background: var(--sidebar); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #333; flex-shrink: 0; transition: transform 0.3s ease; z-index: 2000; }
    .logo { font-size: 1.4rem; font-weight: bold; color: var(--primary); margin-bottom: 40px; text-align: center; letter-spacing: 1px; text-transform: uppercase; }
    
    .nav-btn { background: transparent; border: none; color: var(--text-muted); text-align: left; padding: 15px; font-size: 1rem; cursor: pointer; border-radius: 8px; margin-bottom: 8px; transition: 0.3s; display: flex; align-items: center; gap: 12px; font-weight: 500; width: 100%; }
    .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(225, 78, 202, 0.4); }
    
    .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; -webkit-overflow-scrolling: touch; }
    
    /* MENU HAMBURGUER (Mobile) */
    .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 3000; background: var(--primary); border: none; color: white; padding: 10px 15px; border-radius: 8px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1500; }

    /* --- COMPONENTES UI --- */
    .view { display: none; animation: fade 0.4s ease-out; padding-bottom: 50px; }
    .view.active { display: block; }
    @keyframes fade { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }

    h1 { margin: 0 0 25px 0; font-weight: 300; letter-spacing: 0.5px; border-bottom: 1px solid #333; padding-bottom: 15px; display:flex; justify-content:space-between; align-items:center; }
    .card { background: var(--card-bg); padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    
    input, select, textarea { width: 100%; padding: 12px 15px; background: var(--input-bg); border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 15px; font-family: inherit; font-size: 0.95rem; transition: 0.3s; }
    input:focus, select:focus { border-color: var(--primary); outline: none; }

    .btn { padding: 10px 25px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-p { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(225, 78, 202, 0.3); }
    .btn-s { background: transparent; border: 1px solid #666; color: #ccc; }
    .btn-del { background: rgba(253, 93, 147, 0.1); color: var(--danger); border: 1px solid var(--danger); padding: 6px 12px; font-size: 0.8rem; }
    .btn-edit { background: rgba(0, 242, 195, 0.1); color: var(--success); border: 1px solid var(--success); padding: 5px 10px; border-radius:30px; cursor:pointer; font-size:0.8rem; }
    .btn-whats { background: #25D366; color: white; text-decoration: none; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; display: inline-flex; align-items: center; gap:5px; }

    /* DASHBOARD */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .kpi-card { background: linear-gradient(145deg, #323246, #272735); padding: 25px; border-radius: 16px; position: relative; overflow: hidden; border: 1px solid #3a3a4a; }
    .kpi-card::before { content:''; position:absolute; top:0; left:0; width:4px; height:100%; background: var(--primary); }
    .kpi-val { font-size: 2.2rem; font-weight: bold; margin-top: 10px; color: white; }
    .kpi-label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }

    /* SERVIÃ‡OS GRID */
    .services-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    .svc-card { background: #252533; border-radius: 12px; padding: 20px; border: 1px solid #3a3a4a; transition: 0.3s; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
    .svc-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .svc-icon { font-size: 2rem; margin-bottom: 10px; background: rgba(255,255,255,0.05); width: 50px; height: 50px; border-radius: 50%; display:flex; align-items:center; justify-content:center; }
    .svc-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; color: white; }
    .svc-price { color: var(--success); font-weight: bold; font-size: 1.3rem; margin-bottom: 15px; }
    .svc-actions { width: 100%; display: flex; justify-content: center; gap: 10px; }

    /* CLIENTES LIST */
    .client-list-container { display: flex; flex-direction: column; gap: 10px; }
    .client-row { background: #252533; padding: 15px 20px; border-radius: 10px; border-left: 3px solid transparent; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
    .client-row:hover { background: #2a2a3a; border-left-color: var(--primary); }
    .client-info { display: flex; align-items: center; gap: 15px; }
    .client-avatar { width: 45px; height: 45px; background: linear-gradient(135deg, #555, #333); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; flex-shrink: 0; }
    .client-details h4 { margin: 0; font-size: 1rem; color: white; }
    .client-details span { font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; margin-top: 4px; }
    .client-actions { display: flex; gap: 10px; align-items: center; }

    /* AGENDA LIST */
    .agenda-item { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #555; transition:0.2s; }
    .agenda-item:hover { background: rgba(255,255,255,0.05); }
    .agenda-item.booked { border-left-color: var(--success); background: rgba(0, 242, 195, 0.05); }
    .ag-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .time-badge { font-size: 1.2rem; font-weight: bold; background: #444; padding: 5px 10px; border-radius: 6px; }
    .booked .time-badge { background: var(--success); color: #000; }
    .ag-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem; color: #ccc; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px; }
    .ag-price { color: var(--success); font-weight: bold; font-size: 1.1rem; }
    .ag-actions { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
    .summary-bar { display: flex; gap: 20px; margin-bottom: 20px; background: rgba(225, 78, 202, 0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--primary); flex-wrap: wrap; }

    /* LOGIN & MODAL */
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .login-box { background: var(--sidebar); padding: 40px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid var(--primary); }
    .login-box h2 { color: var(--primary); margin-bottom: 20px; font-weight: 300; }
    .login-box input { text-align: center; font-size: 1.1rem; }
    .login-box button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; }
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index: 3000; backdrop-filter: blur(5px); }
    .modal-content { background: var(--card-bg); padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid #444; max-height: 90vh; overflow-y: auto; }
    
    /* HISTÃ“RICO TABLE */
    .hist-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
    .hist-table th { text-align: left; color: var(--primary); border-bottom: 1px solid #555; padding: 8px; }
    .hist-table td { border-bottom: 1px solid #444; padding: 8px; color: #ddd; }

    @media (max-width: 768px) {
      .mobile-menu-btn { display: block; }
      .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 260px; transform: translateX(-100%); box-shadow: 2px 0 15px rgba(0,0,0,0.5); }
      .sidebar.active { transform: translateX(0); }
      .main { padding: 70px 20px 40px 20px; height: 100vh; width: 100%; overflow-y: auto; }
      h1 { font-size: 1.5rem; flex-direction: column; align-items: flex-start; gap: 10px; }
      h1 button { width: 100%; }
      .ag-details { grid-template-columns: 1fr; }
      .client-row { flex-direction: column; align-items: flex-start; gap: 15px; }
      .client-actions { width: 100%; justify-content: flex-end; border-top: 1px solid #444; padding-top: 10px; }
      .card > div[style*="display:flex"] { flex-direction: column; align-items: stretch; }
      .card input[type="date"] { width: 100% !important; }
    }
  </style>
</head>
<body>

<div class="overlay" id="menuOverlay" onclick="toggleMenu()"></div>
<button class="mobile-menu-btn" onclick="toggleMenu()">â˜°</button>

<div id="loginOverlay">
  <div class="login-box">
    <h2>ğŸ”’ Acesso Restrito</h2>
    <p style="color:#ccc; margin-bottom:20px">Digite a senha de administrador</p>
    <input type="password" id="adminPass" placeholder="Senha">
    <button onclick="doLogin()">ENTRAR</button>
  </div>
</div>

<div id="connectionStatus">Verificando...</div>

<div class="sidebar" id="sidebar">
  <div class="logo">Camila ERP</div>
  <button id="btn-dash" class="nav-btn active" onclick="show('dash')">ğŸ“Š Dashboard</button>
  <button id="btn-agenda" class="nav-btn" onclick="show('agenda')">ğŸ“… Agenda</button>
  <button id="btn-servicos" class="nav-btn" onclick="show('servicos')">ğŸ’… ServiÃ§os</button>
  <button id="btn-clientes" class="nav-btn" onclick="show('clientes')">ğŸ‘¥ Clientes</button>
  <div style="flex:1"></div>
  <button class="nav-btn" onclick="openSite()">ğŸŒ Ver Site Cliente</button>
</div>

<div class="main">

  <div id="dash" class="view active">
    <h1>Dashboard Financeiro</h1>
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">Hoje</div><div class="kpi-val" id="kpiHoje">...</div></div>
      <div class="kpi-card" style="border-left-color:var(--success)"><div class="kpi-label">MÃªs</div><div class="kpi-val" id="kpiMes">...</div></div>
    </div>
    <div class="card"><h3>Faturamento (7 dias)</h3><div style="height:250px"><canvas id="chartFin"></canvas></div></div>
  </div>

  <div id="agenda" class="view">
    <h1>Agenda</h1>
    <div class="card" style="border:1px solid var(--primary); background: rgba(225, 78, 202, 0.05);">
      <h3 style="color:var(--primary); margin-top:0">+ Novo HorÃ¡rio Manual</h3>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <div style="flex:1"><label>Data</label><input type="date" id="mData"></div>
        <div style="flex:1"><label>Hora</label><input type="time" id="mHora"></div>
      </div>
      <button class="btn btn-p" style="width:100%" onclick="addManual()">Adicionar Disponibilidade</button>
    </div>
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
        <h3>HorÃ¡rios</h3>
        <div style="display:flex; gap:10px">
          <input type="text" id="searchClient" placeholder="ğŸ” Buscar na agenda..." onkeyup="filterList()" style="margin:0; padding:8px">
          <input type="date" id="filterDate" onchange="loadAgenda()" style="margin:0; width:auto">
          <button class="btn btn-s" onclick="loadAgenda()">ğŸ”„</button>
        </div>
      </div>
      <div class="summary-bar" id="daySummary" style="display:none">
        <div class="sum-item"><span>Agendamentos</span><strong id="sumCount">0</strong></div>
        <div class="sum-item"><span>Previsto</span><strong id="sumTotal">R$ 0,00</strong></div>
      </div>
      <div id="agendaList">Carregando...</div>
    </div>
  </div>

  <div id="servicos" class="view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
      <h1>ServiÃ§os</h1>
      <button class="btn btn-p" onclick="openModal('modalServico')">+ Novo</button>
    </div>
    <div class="card" style="background:transparent; padding:0; box-shadow:none;">
      <div id="serviceList" class="services-grid">Carregando...</div>
    </div>
  </div>

  <div id="clientes" class="view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
      <h1>Clientes</h1>
      <button class="btn btn-p" onclick="openModal('modalCliente')">+ Novo</button>
    </div>
    <div class="card">
      <div id="clientList" class="client-list-container">Carregando...</div>
    </div>
  </div>
</div>

<div id="modalServico" class="modal">
  <div class="modal-content">
    <h3 id="titleServico">ServiÃ§o</h3>
    <input type="hidden" id="sRowIndex">
    <label>Nome</label><input type="text" id="sNome">
    <label>Valor (R$)</label><input type="number" id="sValor">
    <div style="text-align:right; margin-top:10px">
      <button class="btn btn-s" onclick="closeModal('modalServico')">Cancelar</button>
      <button class="btn btn-p" onclick="saveService()">Salvar</button>
    </div>
  </div>
</div>

<div id="modalCliente" class="modal">
  <div class="modal-content">
    <h3 id="titleCliente" style="border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:20px">Ficha</h3>
    <input type="hidden" id="cRowIndex">
    <label>Nome</label><input type="text" id="cNome">
    <label>Telefone</label><input type="text" id="cTel">
    <label>Obs</label><textarea id="cObs" rows="2"></textarea>
    <div style="text-align:right; margin-bottom:20px"><button class="btn btn-p" onclick="saveClient()">Salvar</button></div>
    
    <h4 style="color:var(--primary);border-top:1px solid #444;padding-top:10px">HistÃ³rico</h4>
    <div style="background:#222;padding:10px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between"><span>Visitas: <strong id="histCount">0</strong></span><span>Total: <strong id="histTotal" style="color:var(--success)">R$ 0</strong></span></div>
    <div style="max-height:150px;overflow-y:auto"><table class="hist-table"><thead><tr><th>Data</th><th>ServiÃ§o</th><th>Valor</th></tr></thead><tbody id="histList"></tbody></table></div>
    <button class="btn btn-s" style="width:100%;margin-top:20px" onclick="closeModal('modalCliente')">Fechar</button>
  </div>
</div>

<div id="modalBook" class="modal">
  <div class="modal-content">
    <h3>Reservar</h3>
    <input type="hidden" id="bRowIndex">
    <p id="bInfo" style="margin-bottom:10px;color:#aaa;font-size:0.9rem"></p>
    <label>Cliente</label><input type="text" id="bNome">
    <label>Valor (R$)</label><input type="number" id="bValor">
    <div style="text-align:right; margin-top:10px">
      <button class="btn btn-s" onclick="closeModal('modalBook')">Cancelar</button>
      <button class="btn btn-p" onclick="adminBook()">Confirmar</button>
    </div>
  </div>
</div>

<script>
  // âœ… URL ATUALIZADA
  const API = "https://script.google.com/macros/s/AKfycbw5dJYF56NDJBLvyEPrVLY2gR4twbJ8F_aYHkJM4r-y9dbQHI2THbpIuzQKcNhidDXj/exec";
  let TOKEN = "";

  function toggleMenu() {
    const sb = document.getElementById('sidebar');
    const ov = document.getElementById('menuOverlay');
    if(sb.classList.contains('active')) { sb.classList.remove('active'); ov.style.display = 'none'; }
    else { sb.classList.add('active'); ov.style.display = 'block'; }
  }

  function doLogin() {
    const pass = document.getElementById('adminPass').value;
    if(!pass) return alert("Digite a senha!");
    TOKEN = pass;
    req('check').then(res => {
      document.getElementById('loginOverlay').style.display = 'none';
      checkConnection(); show('dash');
    }).catch(err => { alert("Senha Incorreta!"); TOKEN = ""; });
  }

  async function req(act, p={}) {
    const res = await fetch(API, { method:"POST", body: JSON.stringify({action:act, token:TOKEN, ...p}) });
    const j = await res.json();
    if(!j.success) throw new Error(j.error);
    return j.data;
  }

  function checkConnection() {
    const st = document.getElementById('connectionStatus'); st.style.display = 'block';
    req('check').then(m => { st.innerText = m; st.className = 'status-ok'; }).catch(e => { st.innerText = "Offline"; st.className = 'status-err'; });
  }

  function show(id) {
    if(window.innerWidth <= 768) toggleMenu();
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(document.getElementById('btn-'+id)) document.getElementById('btn-'+id).classList.add('active');
    if(id==='dash') loadDash();
    if(id==='agenda') loadAgenda();
    if(id==='servicos') loadServices();
    if(id==='clientes') loadClients();
  }

  function openSite() { window.open("https://alexamaralf.github.io/camilasilva/", '_blank'); }
  function openModal(id) { document.getElementById(id).style.display='flex'; }
  function closeModal(id) { document.getElementById(id).style.display='none'; }

  let chart=null;
  function loadDash() {
    req('getDashboard').then(d => {
      document.getElementById('kpiHoje').innerText = "R$ " + d.totalHoje.toFixed(2);
      document.getElementById('kpiMes').innerText = "R$ " + d.totalMes.toFixed(2);
      const ctx = document.getElementById('chartFin').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: d.labels, datasets: [{ label: 'Receita', data: d.values, backgroundColor: '#e14eca', borderRadius: 5 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } } }
      });
    });
  }

  function loadServices() {
    req('getServices').then(l => {
      let h = ''; l.forEach(s => {
        h += `<div class="svc-card"><div class="svc-icon">ğŸ’…</div><div class="svc-name">${s.nome}</div><div class="svc-price">R$ ${s.valor}</div><div class="svc-actions"><button class="btn-edit" onclick="openEditService(${s.rowIndex}, '${s.nome}', '${s.valor}')">âœï¸</button><button class="btn-del" onclick="delItem('delService', ${s.rowIndex})">ğŸ—‘ï¸</button></div></div>`;
      });
      document.getElementById('serviceList').innerHTML = h || '<div style="text-align:center;padding:20px">Vazio</div>';
    });
  }
  function openEditService(row, nome, valor) {
    document.getElementById('sRowIndex').value = row || '';
    document.getElementById('sNome').value = nome || '';
    document.getElementById('sValor').value = valor || '';
    document.getElementById('titleServico').innerText = row ? "Editar ServiÃ§o" : "Novo ServiÃ§o";
    document.getElementById('modalServico').style.display = 'flex';
  }
  function saveService() {
    const row = document.getElementById('sRowIndex').value;
    const nome = document.getElementById('sNome').value;
    const valor = document.getElementById('sValor').value;
    if(!nome) return alert("Nome?");
    const action = row ? 'editService' : 'addService';
    req(action, {rowIndex:row, nome:nome, valor:valor}).then(() => { closeModal('modalServico'); loadServices(); });
  }

  function loadClients() {
    const divList = document.getElementById('clientList');
    divList.innerHTML = '<div style="text-align:center; padding:20px">Carregando clientes...</div>';
    req('getClients').then(l => {
      let h = '';
      if(!l || l.length === 0) { divList.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa">Nenhum cliente cadastrado.</div>'; return; }
      l.forEach(c => {
        let nomeDisplay = c.nome || "Cliente Sem Nome";
        let telDisplay = c.tel || "";
        let cleanTel = telDisplay.replace(/\D/g, '');
        let ini = nomeDisplay.substring(0, 2).toUpperCase();
        h += `<div class="client-row">
                <div class="client-info">
                  <div class="client-avatar">${ini}</div>
                  <div>
                    <div style="font-weight:bold; color:white">${nomeDisplay}</div>
                    <div style="font-size:0.85rem; color:#aaa">${telDisplay}</div>
                  </div>
                </div>
                <div class="client-actions">
                  ${cleanTel ? `<a href="https://wa.me/55${cleanTel}" target="_blank" class="btn-whats">ğŸ“²</a>` : ''}
                  <button class="btn-edit" onclick="openEditClient(${c.rowIndex}, '${nomeDisplay}', '${telDisplay}', '${c.obs||''}')">â„¹ï¸</button> 
                  <button class="btn-del" onclick="delItem('delClient', ${c.rowIndex})">ğŸ—‘ï¸</button>
                </div>
              </div>`;
      });
      divList.innerHTML = h;
    }).catch(err => { divList.innerHTML = '<div style="text-align:center; color:#fd5d93; padding:20px">Erro ao buscar clientes.</div>'; });
  }
  function openEditClient(row, nome, tel, obs) {
    document.getElementById('cRowIndex').value = row || '';
    document.getElementById('cNome').value = nome || '';
    document.getElementById('cTel').value = tel || '';
    document.getElementById('cObs').value = obs || '';
    document.getElementById('titleCliente').innerText = row ? "Ficha: "+nome : "Novo Cliente";
    
    const tb = document.getElementById('histList'); tb.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
    document.getElementById('histCount').innerText='0'; document.getElementById('histTotal').innerText='R$ 0,00';

    if(row && nome) {
        req('getClientHistory', {nome:nome}).then(res => {
            document.getElementById('histCount').innerText = res.count;
            document.getElementById('histTotal').innerText = "R$ " + res.totalGasto.toFixed(2);
            let h = ''; res.lista.forEach(i => { h += `<tr><td>${i.data}</td><td>${i.servico}</td><td>${i.valor}</td></tr>`; });
            tb.innerHTML = h || '<tr><td colspan="3">Sem histÃ³rico.</td></tr>';
        });
    } else tb.innerHTML = '<tr><td colspan="3">Novo.</td></tr>';
    document.getElementById('modalCliente').style.display = 'flex';
  }
  function saveClient() {
    const row = document.getElementById('cRowIndex').value;
    const nome = document.getElementById('cNome').value;
    const tel = document.getElementById('cTel').value;
    const obs = document.getElementById('cObs').value;
    const action = row ? 'editClient' : 'addClient';
    req(action, {rowIndex:row, nome:nome, tel:tel, obs:obs}).then(() => { if(!row) closeModal('modalCliente'); else alert("Salvo!"); loadClients(); });
  }

  function loadAgenda() {
    const dt = document.getElementById('filterDate').value;
    document.getElementById('agendaList').innerHTML = '<div style="text-align:center; padding:20px">Carregando...</div>';
    req('listSlots', {filtroData:dt}).then(l => {
      let h = ''; let c=0; let r=0; if(l.length===0) h='<p style="text-align:center;color:#666">Nada na agenda.</p>';
      l.forEach(s => {
        let isBooked = s.status === 'Agendado';
        if(isBooked) { c++; r+=parseFloat(String(s.valor).replace("R$","").replace(",",".")||0); }
        let acts = isBooked ? `<a href="https://wa.me/55${s.tel.replace(/\D/g,'')}" target="_blank" class="btn-whats">WhatsApp</a> <button class="btn-del" onclick="cancelSlot(${s.rowIndex})">Cancelar</button>` : `<button class="btn-p" style="padding:5px 10px" onclick="prepBook(${s.rowIndex}, '${s.hora}')">Reservar</button><button class="btn-del" onclick="delSlot(${s.rowIndex})">ğŸ—‘ï¸</button>`;
        h += `<div class="agenda-item ${isBooked?'booked':''} search-item"><div class="ag-header"><div class="time-badge">${s.hora} <span style="font-size:0.7rem;opacity:0.7">${s.data}</span></div><span class="status-tag ${isBooked?'ocup':'disp'}">${s.status}</span></div>${isBooked ? `<div class="ag-details"><div>ğŸ‘¤ ${s.cliente}</div><div>âœ‚ï¸ ${s.servicos}</div><div>ğŸ“ ${s.tel}</div><div class="ag-price">ğŸ’° ${s.valor}</div></div>` : ''}<div class="ag-actions">${acts}</div><div style="display:none" class="search-text">${s.cliente}</div></div>`;
      });
      document.getElementById('agendaList').innerHTML = h;
      document.getElementById('daySummary').style.display = dt ? 'flex' : 'none';
      document.getElementById('sumCount').innerText = c;
      document.getElementById('sumTotal').innerText = "R$ "+r.toFixed(2);
    });
  }

  function filterList() {
    let val = document.getElementById('searchClient').value.toLowerCase();
    let items = document.getElementsByClassName('search-item');
    for(let i=0; i<items.length; i++) {
      let txt = items[i].getElementsByClassName('search-text')[0].innerText.toLowerCase();
      items[i].style.display = txt.includes(val) ? "" : "none";
    }
  }

  function addManual() { const d=document.getElementById('mData').value; const h=document.getElementById('mHora').value; if(!d||!h) return alert("Preencha!"); req('addSingle', {data:d, hora:h}).then(()=>{alert("Adicionado!");loadAgenda()}); }
  function delSlot(id) { if(confirm("Excluir?")) req('deleteSlot', {id:id}).then(()=>loadAgenda()); }
  function cancelSlot(id) { if(confirm("Cancelar?")) req('cancel', {id:id}).then(()=>loadAgenda()); }
  function delItem(act, id) { if(confirm("Excluir?")) req(act, {id:id}).then(()=>{ if(act.includes('Service')) loadServices(); else loadClients(); }); }
  function prepBook(id, info) { document.getElementById('bRowIndex').value=id; document.getElementById('bInfo').innerText="Reservar: "+info; openModal('modalBook'); }
  function adminBook() { const id=document.getElementById('bRowIndex').value; const n=document.getElementById('bNome').value; const v=document.getElementById('bValor').value; req('book', {rowIndex:id, nome:n, telefone:'Admin', servicos:'Manual', valor:v}).then(()=>{closeModal('modalBook');loadAgenda()}); }
</script>
</body>
</html>
